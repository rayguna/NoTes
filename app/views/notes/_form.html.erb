<head>
  <link rel="stylesheet" href="<%= asset_path('notes_form.css') %>">
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const fileInput = document.querySelector('input[type="file"]');
      const form = document.getElementById('note-form');
      const fileSizeLabel = document.createElement('span');
      const maxFileSize = 1 * 1024 * 1024; // 1 MB
      const validImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];

      fileSizeLabel.style.color = 'gray';
      fileSizeLabel.style.marginLeft = '10px';
      fileInput.parentNode.appendChild(fileSizeLabel);

      fileInput.addEventListener('change', function(event) {
        const file = event.target.files[0];

        if (file) {
          const fileSize = file.size;
          const fileType = file.type;

          // Check if file is a valid image type
          if (!validImageTypes.includes(fileType)) {
            fileSizeLabel.style.color = 'red';
            fileSizeLabel.textContent = 'Invalid file type! Please upload a valid image (JPEG, PNG, GIF, or WebP).';
            alert('Invalid file type! Please upload a valid image (JPEG, PNG, GIF, or WebP).');
            form.querySelector('input[type="submit"]').disabled = true;
            return;
          }

          // Check if file size exceeds 1 MB
          fileSizeLabel.textContent = `File size: ${(fileSize / 1024 / 1024).toFixed(2)} MB`;
          if (fileSize > maxFileSize) {
            fileSizeLabel.style.color = 'red';
            fileSizeLabel.textContent += ' - File exceeds 1 MB limit!';
            alert('The uploaded image exceeds the 1 MB size limit. Please upload a smaller file.');
            form.querySelector('input[type="submit"]').disabled = true;
          } else {
            fileSizeLabel.style.color = 'gray';
            form.querySelector('input[type="submit"]').disabled = false;
          }
        }
      });
    });
  </script>
</head>

<%= form_with(model: @note, local: true, id: 'note-form') do |form| %>
  <%= form.hidden_field :topic_id, value: params[:topic_id] || @note.topic_id %>

  <% if @note.errors.any? %>
    <div style="color: red">
      <h2><%= pluralize(@note.errors.count, "error") %> prohibited this note from being saved:</h2>
      <ul>
        <% @note.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="form-group">
    <%= form.label :title, style: "display: block" %>
    <%= form.text_field :title, class: 'form-control' %>
  </div>

  <div class="form-group">
    <%= form.label :content, style: "display: block" %>
    <%= form.text_area :content, value: params[:content] || @note.content, class: 'form-control', id: 'note-content' %>
  </div>

  <%= form.hidden_field :user_id, value: current_user.id %>
  <%= form.hidden_field :topic_id, value: @note.topic_id %>

  <!-- Add an image -->
  <div class="mb-3">
    <%= form.label :image, class: 'form-label' %>
    <%= form.file_field :note_image, class: "form-control" %>
    <div class="invalid-feedback">
      Please upload a valid image file.
    </div>
  </div>

  <div class="form-group">
    <%= form.submit 'Save', class: 'btn btn-primary' %>
  </div>
<% end %>

<div id="markdown-preview" style="border: 1px solid #ddd; padding: 10px; margin-top: 20px;">
  <u>Markdown Preview</u>
  <div id="preview-content"><%= @markdown_preview %></div>
</div>
